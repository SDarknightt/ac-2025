package org.example.dayseven;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;

public class DaySevenPartTwo {

    public static void main(String[] args) {
        String inputReal = """
                ......................................................................S......................................................................
                .............................................................................................................................................
                ......................................................................^......................................................................
                .............................................................................................................................................
                .....................................................................^.^.....................................................................
                .............................................................................................................................................
                ....................................................................^.^.^....................................................................
                .............................................................................................................................................
                ...................................................................^.^...^...................................................................
                .............................................................................................................................................
                ..................................................................^.^.^.^.^..................................................................
                .............................................................................................................................................
                .................................................................^.^.^...^.^.................................................................
                .............................................................................................................................................
                ................................................................^.^.^...^.^.^................................................................
                .............................................................................................................................................
                ...............................................................^...^...^.^.^.^...............................................................
                .............................................................................................................................................
                ..............................................................^.^.^...^...^.^.^..............................................................
                .............................................................................................................................................
                .............................................................^.^.^...^.^...^.^.^.............................................................
                .............................................................................................................................................
                ............................................................^.....^.^.^.^.^.^.^.^............................................................
                .............................................................................................................................................
                ...........................................................^...^.^...^.^...^...^.^...........................................................
                .............................................................................................................................................
                ..........................................................^.^.^.^.^...^...^.^.....^..........................................................
                .............................................................................................................................................
                .........................................................^.^.^...^.^.^...^...^.....^.........................................................
                .............................................................................................................................................
                ........................................................^.^.....^.^.^.^.^.^.^.^.^...^........................................................
                .............................................................................................................................................
                .......................................................^...^.^.^.^.^...^...^.^...^.^.^.......................................................
                .............................................................................................................................................
                ......................................................^.^.^.^...^.......^...^.....^.^.^......................................................
                .............................................................................................................................................
                .....................................................^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.....................................................
                .............................................................................................................................................
                ....................................................^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^....................................................
                .............................................................................................................................................
                ...................................................^.^.....^.^.^...^...^.^.^.^...^.......^...................................................
                .............................................................................................................................................
                ..................................................^...^.......^.....^...^.^.^.^.^.^...^...^..................................................
                .............................................................................................................................................
                .................................................^.^.^.....^.^.^.^...^.^...^.^.^.^.^...^.^.^.................................................
                .............................................................................................................................................
                ................................................^.^.^...^.^...^.^.......^...^...^.^.^.^.^.^.^................................................
                .............................................................................................................................................
                ...............................................^.........^...^.^.......^.....^.^.^...^.^.^.^.^...............................................
                .............................................................................................................................................
                ..............................................^.^.^.^.^.^...^.^.....^...^.^.^...^...^.^...^.^.^..............................................
                .............................................................................................................................................
                .............................................^...^.^.^.......^.....^.^.^.^...^.^.....^.^.....^.^.............................................
                .............................................................................................................................................
                ............................................^...^...^.^.^...^...^.^.^...^...^.....^.^.^.^.^.^.^.^............................................
                .............................................................................................................................................
                ...........................................^.....^...^.....^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...........................................
                .............................................................................................................................................
                ..........................................^.^.^...^...^.^.....^...^.......^.^...^.^.^.^...^.^...^.^..........................................
                .............................................................................................................................................
                .........................................^.^.^...^...^.^.^.^...^.^...^.^.^.^...^.....^.^.^.^.^...^.^.........................................
                .............................................................................................................................................
                ........................................^.^.^...^...^.^.^.^.....^.^.......^.....^...^.^.^.^.^.....^.^........................................
                .............................................................................................................................................
                .......................................^.^.^...^.^.^...^.^.^.^.^.^...^.^...^.^.^.........^.^.^.....^.^.......................................
                .............................................................................................................................................
                ......................................^.^.^...^.....^.^.^.^.....^...^.......^.^.....^.^.^...^...^...^.^......................................
                .............................................................................................................................................
                .....................................^.^.^.^...^.....^.....^.^.^.^.....^.^.^.....^.^...............^...^.....................................
                .............................................................................................................................................
                ....................................^.^.^.^.....^.^.^...^...^.....^.^.^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^....................................
                .............................................................................................................................................
                ...................................^...^.^...^.....^.^...^...^.^.^.^...^...^.....^.....^.^...^.^.^...^.^.^...................................
                .............................................................................................................................................
                ..................................^.^.^.^.......^...^.^.^.^...^.....^.^...^.^.^...^.^.^.^.^.^.^...^.^...^.^..................................
                .............................................................................................................................................
                .................................^.....^.^.^.....^.....^.^.^.^.^.^...^.........^.^.^.^.^.....^...^.^.^.^...^.................................
                .............................................................................................................................................
                ................................^.^.^.^.^.^.^.^...^.^.......^.^.....^.^.^.^...^...^.^.^.......^...^.......^.^................................
                .............................................................................................................................................
                ...............................^.^...^.^...^...^.^.^.^.^...^.^...^.^...^...^...^...^.^.^.^.^.^...^...^.^...^.^...............................
                .............................................................................................................................................
                ..............................^.^...^.^...^...^...^.^.^.^...^...^.^.....^.^...^.^.^...^.^.^.^...^.^.^.^.^.^.^.^..............................
                .............................................................................................................................................
                .............................^.^.........^.^.^.....^.^.^...^.^.^.^.^.^.^...^...^.^...^...^.^.....^.^.^.^.^.^.^.^.............................
                .............................................................................................................................................
                ............................^.^.^...^...^.^.....^.......^...^.^...^...^.^.....^...^.^.....^.^.^...^.^.^.^.^.....^............................
                .............................................................................................................................................
                ...........................^.^.^...^.^...^.^.^...^.^.^.^.^...^.^.^...^.^.^.^.....^...^...^.^...^...^.^.^...^.^.^.^...........................
                .............................................................................................................................................
                ..........................^...^.......^.^.^.^.^.....^.^.....^.^.^.^.^.^...^.^.......^.^...^.^.^...^...^...^.^.^...^..........................
                .............................................................................................................................................
                .........................^.^.^.^.^...^...^.^.^.^...^.^...^...^...^.^.^.^.^.^.....^...^.^.^.^.^.^.^.....^.^.^.^.....^.........................
                .............................................................................................................................................
                ........................^.^...^.^.^.^.^.^.....^.^.^.^.^...^.^.^...^.^.....^.^.....^...^.....^.^.^.^.^.^.^.^.^.....^.^........................
                .............................................................................................................................................
                .......................^.^.^.^.....^.^.....^.^...^.^...........^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.......................
                .............................................................................................................................................
                ......................^.^.^...^.^...^.^.^.^.^.^.........^.....^.^.....^.^.^.^...^...^...^.^.^.^.^.^.^...^.^.......^.^.^......................
                .............................................................................................................................................
                .....................^.^.^...^.^...^...^.....^.^.^...^.^.^...^.^...^...^...^.^.^.^.^...^.^...^.^.^...^...^.^.^.^.^.....^.....................
                .............................................................................................................................................
                ....................^.^.....^.....^.^.^.^.^.^.^.^.^.^...^...^.^.....^.^.^.^...^...^...^.^.^.^.^...^.^.....^.^...^...^.^.^....................
                .............................................................................................................................................
                ...................^.^...^...^...^.^.........^...^.^...^...^.^.^.^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^...^...^.^.^.^...^.^...................
                .............................................................................................................................................
                ..................^.^.....^.^.^.....^...^.^.^.^.^.^...^.^.....^.^...^...^.^.^...^.^...^.^.^.^.^...^...^.^...^.^.^.^.^...^.^..................
                .............................................................................................................................................
                .................^...^.^...^.^.^...^.....^.^.^.^...^...^...^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.....^...^.^...^...^.^...^.^...^.................
                .............................................................................................................................................
                ................^.......^.^.^...^.^.....^.^.....^...^...^.........^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^...^.^...^...^.^.^.^.^................
                .............................................................................................................................................
                ...............^.^.^.^...^.^...^.^.^.^.......^.^.....^.^.^.^.^.^.^.^.^.....^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^...^...^.^...............
                .............................................................................................................................................
                ..............^.^.....^...^...^...^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.....^.^.^...^.....^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^..............
                .............................................................................................................................................
                .............^.^.^.^.^.^.....^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^...^.^.......^...^.^.^.^.....^.^.^.^.^.^.^.....^.^.^.^.............
                .............................................................................................................................................
                ............^...^...^.^.^.......^.^.^...^...^...^.^.^.^...^.^.^.^.....^...^...^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.....^.^...^.^.^............
                .............................................................................................................................................
                ...........^.^.......^.^.^.^.......^.^.^...^...^.^.^.^.^.^.^.^.^.......^.^.^.^.^.^.....^.^...^.^.^.....^.^.^.^...^.^...^.^.^...^.^...........
                .............................................................................................................................................
                ..........^.^...^...^.....^.^.......^.^.^.^.^.^.^.^.^.^...^.^.^.^.....^...^.^.....^.^.^...^.^.....^.......^...^.^.^...^.^.^.^.^.^.^..........
                .............................................................................................................................................
                .........^...^.^.^.^.......^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.......^.^.^...^.^...^.^...^.....^...^.^.^...^.....^.^...^.^.^.^.........
                .............................................................................................................................................
                ........^.^.......^.^.^.^.^.^...^.....^...^.......^.^.^.^...^.^...^.....^.....^.^.....^.^.^.......^.^.^.^.^.....^...^.^...^.^.^.^.^.^........
                .............................................................................................................................................
                .......^.^.^.^.......^.^.^...^.^.^.^.^.^...^.^.^...^.^.^.^...^.^.^.^.^.^...^.^...........^.^...^.^...^.^.....^.^.^.......^.^.^...^.^.^.......
                .............................................................................................................................................
                ......^.^...^.^...^.^.^.^.....^...^.^...^.....^.^...^.^.^.....^.^.^.........^.....^.^.....^.^.^.^.^.^...^.^.^...^...^.....^.^.^.^.^.^.^......
                .............................................................................................................................................
                .....^.^.....^.^.^.^.^.^.^...^.^...^...^...^.^.^.....^.^...^.....^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.....^.^.^.^.....^.^...^.^.^...^.....
                .............................................................................................................................................
                ....^.^...^.^...^.^.^.^.^.^.^.^.....^...^.......^.^.^.^.^...^.......^.^.^.^.......^.............^.^.^.^.^.^.^...^.^.^.^.....^.^.^.^.....^....
                .............................................................................................................................................
                ...^.^.^.^.^.^.^.^.^.^.^.^...^...^.^...^...^.^.^.^...^.^.^.^.^.^.^...^.^.^...^.....^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.....^.^...^.....^.^...
                .............................................................................................................................................
                ..^...^.^.^.^.^...^.^.^.^...^...^...^.^.....^...^.....^.^.....^.^.^...^.^.^...^.^...^...^...^.^.^...^.^...^.^.....^.^...^.^.....^...^...^.^..
                .............................................................................................................................................
                .^.^.......^...^.^...^.^...^.^...^.^.^.^.^.........^.^.......^.^.^.......^.^.^.^.^.^...^.^...^.^.......^.....^.^.^.^.^.^.^.^...^...^.^...^.^.
                .............................................................................................................................................
                """;
        String inputTest = """
                .......S.......
                ...............
                .......^.......
                ...............
                ......^.^......
                ...............
                .....^.^.^.....
                ...............
                ....^.^...^....
                ...............
                ...^.^...^.^...
                ...............
                ..^...^.....^..
                ...............
                .^.^.^.^.^...^.
                ...............
                """;
        // Expected output: 40

        // Quebra linhas
        String[] lines = inputReal.split("\n");
        DaySevenPartTwo daySeven = new DaySevenPartTwo();
        ArrayList<ArrayList<String>> matrix = daySeven.convertStringToMatrix(lines);
        int indexStartAxysX = -1;

        for (int column = 0; column < matrix.getFirst().size(); column++) {
            String curr =  matrix.getFirst().get(column);
            if (curr.equals("S")) {
                indexStartAxysX = column;
                break;
            }
        }

        // Desenha as linhas na matriz
        daySeven.drawLines(matrix);

        // Usa recursão para encontrar todas as possibilidades de chegada ao fim
        // Passa o as coordenadas X,Y do inicio da recursão na matriz
        // HashMap para cache das possibilidades a partir de cada nó
        long total = daySeven.recursiveSearch(matrix, new int[]{indexStartAxysX, 0}, new HashMap<>());
        System.out.println("Total possibility: " + total);
    }

    ArrayList<ArrayList<String>> convertStringToMatrix(String[] input) {
        ArrayList<ArrayList<String>> matrix = new ArrayList<>();

        //Itera verticalmente - linhas
        for (int i = 0; i < input.length; i++) {
            String[] current = input[i].split("");

            ArrayList<String> newCol = new ArrayList<>();
            matrix.add(i, newCol);

            // Itera horizontalmente - colunas
            Arrays.stream(current).forEach(s -> newCol.add(s));
        }
        return matrix;
    }

    void drawLines(ArrayList<ArrayList<String>> matrix) {
        // Inicia na segunda linha por que a primeira é apenas "S"
        for (int row = 1; row < matrix.size(); row++) {
            for (int col = 0; col < matrix.get(row).size(); col++) {

                //Analisa o que há na linha anterior
                String last = matrix.get(row-1).get(col);
                String current = matrix.get(row).get(col);

                if (current.equals("^") && last.equals("|")) {
                    // Analisa as extremidadas esquerda e direita antes de editar

                    // Esquerda
                    if (col >= 0) {
                        String left = matrix.get(row).get(col-1);
                        if (left.equals(".")) {
                            matrix.get(row).set(col-1, "|");
                        }
                    }
                    if (col < matrix.get(row).size()) {
                        String right = matrix.get(row).get(col + 1);
                        if (right.equals(".")) {
                            matrix.get(row).set(col + 1, "|");
                        }
                    }

                } else if (last.equals("S") || last.equals("|")) {
                    matrix.get(row).set(col, "|");
                }
            }
//            System.out.println(matrix.get(row));
        }
    }

    // Retorna quantas possibilidades de chegar até o fim desde o ponto de inicio passado "current[X,Y]"
    // Função recursiva que vai para baixo e para os lados até chegar ao fim
    long recursiveSearch(ArrayList<ArrayList<String>> matrix, int[] current, HashMap<String, Long> mapPossibility) {
        int X = current[0];
        int Y = current[1];

        long possibilityByThisPoint = 0;

        // Para evitar o acesso a indice fora do limite
        if (Y > matrix.size() || X > matrix.getFirst().size()) return possibilityByThisPoint;

        // Evita entrar de novo na mesma ramificação
        String visiting = "";
        visiting += X + "," + Y;

        // Se uma recursão ja chegou a esse ponto e descobriu quantas são as possibilidades
        // A próxima a chegar nesse ponto apenas retorna o valor ja descoberto
        if (mapPossibility.containsKey(visiting)) {
            return possibilityByThisPoint + mapPossibility.get(visiting);
        }

        String currentPoint = matrix.get(Y).get(X);

        if (Y == (matrix.size()-1)) {
            return 1; //Chegou ao fim conta uma possibilidade
        }

        if (currentPoint.equals("^")) {
            // Direita
            if ((X+1) < matrix.getFirst().size()) {
                possibilityByThisPoint += recursiveSearch(matrix, new int[] {X+1, Y}, mapPossibility);
            }

            // Esquerda
            if ((X-1) >= 0) {
                possibilityByThisPoint += recursiveSearch(matrix, new int[] {X-1, Y}, mapPossibility);
            }
        }

        // Baixo
        if (currentPoint.equals("S") || currentPoint.equals("|")) {
            possibilityByThisPoint += recursiveSearch(matrix, new int[] {X, Y+1}, mapPossibility);
        }

        // O primeiro que calcular desse ponto da árvore para baixo, salva quantas são as possibilidades
        mapPossibility.put(visiting, possibilityByThisPoint);

        return possibilityByThisPoint;
    }
}


